<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Início da Pesquisa Principal</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container welcome-container">
        <h1>Pesquisa Principal</h1>
        <p>Você concluiu o tutorial. Agora, prepare-se para a pesquisa principal.</p>
        <p>A pesquisa será dividida em três partes.</p>
        <button id="start-button">Iniciar Pesquisa</button>
    </div>

    <script>
        document.getElementById("start-button").addEventListener("click", async function() {
            const gasUrl = 'https://script.google.com/macros/s/AKfycbx_BSeYfATPGj4lzJImTnB8oyXCFRkznmfaHEbN7OscX-xEpfXG_9Vk8cz98USiD24SjA/exec';
            
            const startButton = document.getElementById("start-button");
            startButton.textContent = "Carregando...";
            startButton.disabled = true;

            const postData = { action: 'getNextSurvey' };
            const formData = new FormData();
            formData.append('data', JSON.stringify(postData));

            try {
                // Faz a requisição para obter a próxima pesquisa com menor contador
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    body: formData,
                });
                
                // Como estamos usando no-cors, não podemos ler a resposta diretamente
                // Vamos implementar um fallback que funciona com a lógica do servidor
                
                // Aguarda um tempo para o servidor processar
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Faz uma segunda requisição para tentar obter o resultado
                const getResponse = await fetch(gasUrl + '?action=getNextSurvey', {
                    method: 'GET',
                });
                
                if (getResponse.ok) {
                    const result = await getResponse.json();
                    if (result.nextSurvey) {
                        // Salva qual pesquisa foi selecionada para incrementar o contador depois
                        localStorage.setItem('selectedSurvey', result.nextSurvey);
                        window.location.href = result.nextSurvey;
                    } else {
                        throw new Error('Resposta inválida do servidor');
                    }
                } else {
                    throw new Error('Erro na resposta do servidor');
                }
                
            } catch (error) {
                console.error('Erro ao conectar ao servidor:', error);
                
                // Fallback: seleciona uma pesquisa aleatória se houver erro
                const surveyPages = ['survey.html', 'survey1.html', 'survey2.html'];
                const randomSurvey = surveyPages[Math.floor(Math.random() * surveyPages.length)];
                localStorage.setItem('selectedSurvey', randomSurvey);
                window.location.href = randomSurvey;
                
            } finally {
                startButton.textContent = "Iniciar Pesquisa";
                startButton.disabled = false;
            }
        });
    </script>
</body>
</html>